class t{constructor(t,e,i){this.position=t,this.size=e,this.userData=i}}class e{constructor(t,e){this.x=t,this.y=e}set(t,e){return this.x=t,this.y=e,this}equals(t){return this.x===t.x&&this.y===t.y}clone(){return new e(this.x,this.y)}min(){return Math.min(this.x,this.y)}max(){return Math.max(this.x,this.y)}fn(t){return this.x=t(this.x),this.y=t(this.y),this}static fromAngle(t){return new e(Math.cos(t),Math.sin(t))}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}length(){return this.magnitude()}dot(t){return this.x*t.x+this.y*t.y}static normalize(t){let i=t.magnitude();return 0===i?new e(0,0):new e(t.x/i,t.y/i)}normalize(){let t=this.magnitude();return 0===t?(this.x=0,this.y=0):(this.x/=t,this.y/=t),this}static add(t,i){return new e(t.x+i.x,t.y+i.y)}static addScalar(t,i){return new e(t.x+i,t.y+i)}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}static sub(t,i){return new e(t.x-i.x,t.y-i.y)}static subScalar(t,i){return new e(t.x-i,t.y-i)}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}static mul(t,i){return new e(t.x*i.x,t.y*i.y)}static mulScalar(t,i){return new e(t.x*i,t.y*i)}mul(t){return this.x*=t.x,this.y*=t.y,this}mulScalar(t){return this.x*=t,this.y*=t,this}static div(t,i){return new e(t.x/i.x,t.y/i.y)}static divScalar(t,i){return new e(t.x/i,t.y/i)}div(t){return this.x/=t.x,this.y/=t.y,this}divScalar(t){return this.x/=t,this.y/=t,this}}class i{constructor(t){this.data=[],this.comparator=t}push(t){this.data.push(t);for(let t=this.data.length-1;t>0;){let e=t-1>>>1;if(0>=this.comparator(this.data[t],this.data[e]))break;[this.data[e],this.data[t]]=[this.data[t],this.data[e]],t=e}}pop(){if(0===this.data.length)return null;let t=this.data[0],e=this.data.pop();if(this.data.length>0){this.data[0]=e;for(let t=0;;){let e=(t<<1)+1,i=e+1,s=t;if(e<this.data.length&&this.comparator(this.data[e],this.data[s])>0&&(s=e),i<this.data.length&&this.comparator(this.data[i],this.data[s])>0&&(s=i),s===t)break;[this.data[t],this.data[s]]=[this.data[s],this.data[t]],t=s}}return t}get size(){return this.data.length}}function s(t,e){return t.size.x*t.size.y-e.size.x*e.size.y}function n(...t){return t.join(",")}function o(t){return n(t.position.x,t.position.y,t.size.x,t.size.y)}class l{constructor(t,e,i){this.p1=t,this.p2=e,this.userData=i}}const r=t=>t*Math.PI/180,a=(t,e)=>Math.hypot(e.x-t.x,e.y-t.y),h=(t,e)=>Math.atan2(e.y-t.y,e.x-t.x),c=(t,e,i)=>Math.max(e,Math.min(i,t));function p(t){return(t=(t+Math.PI)%(2*Math.PI))<0?t+Math.PI:t-Math.PI}function u(t,i){let{p1:{x:s,y:n},p2:{x:o,y:l}}=t,{p1:{x:r,y:a},p2:{x:h,y:c}}=i,p=o-s,u=l-n,y=h-r,d=c-a,x=d*p-y*u;if(!x)return null;let f=s-r,g=n-a,w=(y*g-d*f)/x,v=(p*g-u*f)/x;return{position:new e(s+w*p,n+w*u),cross:w>=0&&w<=1&&v>=0&&v<=1}}function y(t){let{position:i,size:s}=t,n=e.divScalar(s,2);return[e.add(i,new e(-1,-1).mul(n)),e.add(i,new e(1,-1).mul(n)),e.add(i,new e(1,1).mul(n)),e.add(i,new e(-1,1).mul(n))]}function d(t){let e=y(t);return[new l(e[0],e[1]),new l(e[1],e[2]),new l(e[2],e[3]),new l(e[3],e[0])]}function x(t,e,i){let s=Array(e);for(let i=0;i<e;i++)s[i]=Array(t).fill(0);if(!i)return s;for(let n=0;n<e;n++)for(let e=0;e<t;e++)s[n][e]=i(e,n);return s}class f{constructor(t,e,i){this.char=t,this.position=e,this.userData=i}}class g{static fromString(t){let i=t.trim().split("\n"),s=i[0].length,n=i.length,o=new g(s,n);for(let t=0;t<n;t++){let n=i[t];for(let i=0;i<s;i++){let s=new f(n[i],new e(i,t));o.set(i,t,s)}}return o.bake(),o}constructor(t,i){this.rects=[],this.lines=[],this.points=[],this.size=new e(t,i),this.cells=x(t,i)}bake(){(function(l){let r=l.length;if(0===r)return[];let a=l[0].length,h=new Uint8Array(r*a),c=new i(s),p=new Set;!function(i,s,o){let l=i.length,r=i[0].length,a=Array(l).fill(0);for(let h=r-1;h>=0;h--){for(let t=0;t<l;t++)a[t]=i[t][h]?a[t]+1:0;let r=[],c=0;for(let i=0;i<=l;i++){let p=i<l?a[i]:0;if(p>c)r.push({startRow:i,prevWidth:c}),c=p;else if(p<c){for(;r.length>0&&p<c;){let{startRow:l,prevWidth:a}=r.pop(),p=i-l,u=c,y=new t(new e(h,l),new e(u,p)),d=n(h,l,u,p);o.has(d)||(o.add(d),s.push(y)),c=a}p>c&&(r.push({startRow:i,prevWidth:c}),c=p)}}}}(l,c,p);let u=[];for(;c.size>0;){let i=c.pop();if(!i)break;let s=o(i);p.has(s)&&(p.delete(s),function(t,e,i){let s=t.position.x,n=t.position.y,o=t.size.x,l=t.size.y;for(let t=0;t<o;t++){let o=n*i+s+t,r=(n+l-1)*i+s+t;if(1===e[o]||1===e[r])return!1}for(let t=0;t<l;t++){let l=(n+t)*i+s,r=(n+t)*i+s+o-1;if(1===e[l]||1===e[r])return!1}return!0}(i,h,a)?(!function(t,e,i){let s=t.position.x,n=t.position.y,o=t.size.x,l=t.size.y;for(let t=0;t<l;t++){let l=(n+t)*i+s;for(let t=0;t<o;t++)e[l+t]=1}}(i,h,a),u.push(i)):function(i,s,n){let l=i.size.x,r=i.size.y;if(l>1){let a=new t(i.position.clone(),new e(l-1,r)),h=o(a);n.has(h)||(n.add(h),s.push(a))}if(r>1){let a=new t(i.position.clone(),new e(l,r-1)),h=o(a);n.has(h)||(n.add(h),s.push(a))}}(i,c,p))}return u})(x(this.size.x,this.size.y,(t,e)=>+("#"===this.get(t,e).char))).forEach(t=>{t.position.add(e.divScalar(t.size,2)).subScalar(.5);let i=y(t),s=d(t);this.points.push(...i),this.lines.push(...s),this.rects.push(t)})}forEach(t,e=!0){let i;for(let s=0;s<this.size.y;s++){let n=this.cells[s];for(let s=0;s<this.size.x;s++){let o=n[s];if(e&&" "===o.char)continue;let l=()=>i=o;if(t(o,l),i)return i}}return null}find(t){return this.forEach((e,i)=>{e.char===t&&i()})}set(t,e,i){this.cells[e][t]=i}get(t,e){return this.cells[e][t]}}const w=`
############
#    #     #
#    #@    #
#    #     #
#    ##### #
#          #
#          #
#          #
#          #
#          #
# # # # # ##
############
`,v={characters:{" ":"#000000","#":"#ffffff","@":"#80e020"},player:"#0ed180"};class m{constructor(){this.position=new e(0,0),this.isDown=!1,this.ctrl=new AbortController,this.setupEvents()}setupEvents(){let{signal:t}=this.ctrl;document.addEventListener("mousemove",t=>{this.position=new e(t.clientX,t.clientY),this.onMouseMove(t)},{signal:t}),document.addEventListener("mousedown",t=>{this.isDown=!0,this.onMouseDown(t)},{signal:t}),document.addEventListener("mouseup",t=>{this.isDown=!1,this.onMouseUp(t)},{signal:t}),document.addEventListener("click",t=>{this.onMouseClick(t)},{signal:t}),document.addEventListener("wheel",t=>{this.onMouseWheel(t)},{signal:t})}onMouseMove(t){}onMouseDown(t){}onMouseUp(t){}onMouseClick(t){}onMouseWheel(t){}destroy(){this.ctrl.abort()}}class S{constructor(t){this.pressedKeys=new Set,this.ctrl=new AbortController,this.ignoreCase=t?.ignoreCase??!0,this.setupEvents()}getKey(t){return this.ignoreCase?t.toUpperCase():t}isKeyDown(t){return this.pressedKeys.has(this.getKey(t))}setupEvents(){let{signal:t}=this.ctrl;document.addEventListener("keydown",t=>{this.pressedKeys.add(this.getKey(t.key)),this.onKeyDown(t)},{signal:t}),document.addEventListener("keyup",t=>{this.pressedKeys.delete(this.getKey(t.key)),this.onKeyUp(t)},{signal:t})}onKeyDown(t){}onKeyUp(t){}destroy(){this.ctrl.abort()}}class z{constructor(t){this.points=t}}class b extends e{constructor(t=0,e=0,i){super(t,e),this.begin=!1,this.angle=0,this.segment=null,this.visualize=!1,this.userData=i}}class M{constructor(){this.distanceSquared=0}}class D{constructor(t){this.segments=[],this.endpoints=[],this.openSegments=[],this.center=new e(0,0),this.output=[],this.outputPolygon=new z([]),this.intersectionsDetected=[],this.player=t}update(){this.setLightLocation(this.player.position),this.sweep()}loadMap(t){for(let e of(this.segments=[],this.endpoints=[],t))for(let t of d(e))this.addSegment(t)}addSegment(...t){for(let e of t){let t=new M,i=new b(e.p1.x,e.p1.y),s=new b(e.p2.x,e.p2.y);i.segment=t,i.visualize=!0,s.segment=t,s.visualize=!1,t.p1=i,t.p2=s,t.userData=e.userData,i.userData=e.userData,s.userData=e.userData,this.segments.push(t),this.endpoints.push(i,s)}}setBounds(t,i){let s={isBound:!0};this.segments=this.segments.filter(t=>!t.userData?.isBound),this.endpoints=this.endpoints.filter(t=>!t.userData?.isBound),this.addSegment(new l(new e(t.x,t.y),new e(t.x,t.y+i.y),s),new l(new e(t.x,t.y),new e(t.x+i.x,t.y),s),new l(new e(t.x+i.x,t.y),new e(t.x+i.x,t.y+i.y),s),new l(new e(t.x,t.y+i.y),new e(t.x+i.x,t.y+i.y),s))}setLightLocation(t){for(let e of(this.center.set(t.x,t.y),this.segments)){let i=.5*(e.p1.x+e.p2.x),s=.5*(e.p1.y+e.p2.y),n=i-t.x,o=s-t.y;e.distanceSquared=n*n+o*o,e.p1.angle=Math.atan2(e.p1.y-t.y,e.p1.x-t.x),e.p2.angle=Math.atan2(e.p2.y-t.y,e.p2.x-t.x);let l=e.p2.angle-e.p1.angle;l<=-Math.PI&&(l+=2*Math.PI),l>Math.PI&&(l-=2*Math.PI),e.p1.begin=l>0,e.p2.begin=!e.p1.begin}}sweep(t=Number.POSITIVE_INFINITY){this.output=[],this.intersectionsDetected=[],this.endpoints.sort(D.compareEndpoints),this.openSegments=[];let e=0;for(let i=0;i<2;i++)for(let s of this.endpoints){if(1===i&&s.angle>t)break;let n=this.openSegments[0]||null;if(s.begin){let t=s.segment,e=this.openSegments.findIndex(e=>!this.segmentInFrontOf(t,e,this.center));-1===e?this.openSegments.push(t):this.openSegments.splice(e,0,t)}else{let t=this.openSegments.indexOf(s.segment);t>=0&&this.openSegments.splice(t,1)}n!==(this.openSegments[0]||null)&&(1===i&&this.emitTriangle(e,s.angle,n),e=s.angle)}this.outputPolygon=new z(this.output)}getClippedPolygon(t){let e,i=this.output,s=[];for(let e=0;e<2;e++){let n=t[e];for(let t=0;t<i.length;t++){let o=u(n,new l(i[t],i[(t+1)%i.length]));if(o?.cross){s.push({index:t,point:o.position.clone(),ray:e});break}}}let n=s.find(t=>0===t.ray),o=s.find(t=>1===t.ray);if(n&&o)if(n.index===o.index)e=[n.point,o.point];else{let t;t=n.index<o.index?i.slice(n.index+1,o.index+1).map(t=>t.clone()):[...i.slice(n.index+1).map(t=>t.clone()),...i.slice(0,o.index+1).map(t=>t.clone())],e=[n.point,...t,o.point]}else e=[];return e.unshift(this.center.clone()),new z(e)}emitTriangle(t,i,s){let n,o,l=this.center.clone(),r=new e(l.x+Math.cos(t),l.y+Math.sin(t));if(s)n=new e(s.p1.x,s.p1.y),o=new e(s.p2.x,s.p2.y);else{let s=e.fromAngle(t).mulScalar(1e4),r=e.fromAngle(i).mulScalar(1e4);n=l.clone().add(s),o=l.clone().add(r)}let a=D.lineIntersection(n,o,l,r),h=new e(this.center.x+Math.cos(i),this.center.y+Math.sin(i)),c=D.lineIntersection(n,o,l,h);this.output.push(a,c)}segmentInFrontOf(t,e,i){let s=D.leftOf(t,D.interpolate(e.p1,e.p2,.01)),n=D.leftOf(t,D.interpolate(e.p2,e.p1,.01)),o=D.leftOf(t,i),l=D.leftOf(e,D.interpolate(t.p1,t.p2,.01)),r=D.leftOf(e,D.interpolate(t.p2,t.p1,.01)),a=D.leftOf(e,i);return l===r&&r!==a||s===n&&n===o||(s!==n||n===o)&&(l!==r||r!==a)&&(this.intersectionsDetected.push([t.p1,t.p2,e.p1,e.p2]),!1)}static compareEndpoints(t,e){return t.angle>e.angle?1:t.angle<e.angle?-1:!t.begin&&e.begin?1:t.begin&&!e.begin?-1:0}static leftOf(t,e){return(t.p2.x-t.p1.x)*(e.y-t.p1.y)-(t.p2.y-t.p1.y)*(e.x-t.p1.x)<0}static interpolate(t,i,s){return new e(t.x*(1-s)+i.x*s,t.y*(1-s)+i.y*s)}static lineIntersection(t,i,s,n){let o=((n.x-s.x)*(t.y-s.y)-(n.y-s.y)*(t.x-s.x))/((n.y-s.y)*(i.x-t.x)-(n.x-s.x)*(i.y-t.y));return new e(t.x+o*(i.x-t.x),t.y+o*(i.y-t.y))}}class P{constructor(t){this.position=new e(0,0),this.velocity=new e(0,0),this.speed=.0075,this.friction=.875,this.angle=0,this.angleVelocity=0,this.cameraSpeed=.0075,this.cameraFriction=.875,this.fovDegrees=65,this.fov=r(this.fovDegrees),this.position=t}lookAt(t){this.angle=h(this.position,t)}}class C{constructor(t,e,i,s){this.disableMouseCamera=!0,this.player=t,this.keyboard=e,this.cursor=i,this.levelRenderer=s,this.level=s.level,this.cursor.onMouseMove=()=>this.onCursorMove(),this.cursor.onMouseWheel=t=>this.onMouseWheel(t)}update(){this.useComplexController()}useSimpleController(){let{player:t,keyboard:i}=this,s=new e(0,0);i.isKeyDown("W")&&(s.y-=1),i.isKeyDown("S")&&(s.y+=1),i.isKeyDown("A")&&(s.x-=1),i.isKeyDown("D")&&(s.x+=1),s.normalize().mulScalar(t.speed),t.velocity.add(s),t.position.add(t.velocity),t.velocity.mulScalar(t.friction),this.onCursorMove(),this.handleCollisions()}useComplexController(){let{player:t,keyboard:i}=this,s=new e(0,0),n=e.fromAngle(t.angle);i.isKeyDown("W")&&s.add(n),i.isKeyDown("S")&&s.add(e.mulScalar(n,-1)),i.isKeyDown("A")&&(t.angleVelocity-=t.cameraSpeed),i.isKeyDown("D")&&(t.angleVelocity+=t.cameraSpeed),(0!==s.x||0!==s.y)&&(s.normalize().mulScalar(t.speed),t.velocity.add(s)),t.position.add(t.velocity),t.velocity.mulScalar(t.friction),t.angle+=t.angleVelocity,t.angleVelocity*=t.cameraFriction,this.handleCollisions()}handleCollisions(){let{player:i,level:s}=this,n=new t(i.position,new e(.65,.65));for(let t of s.rects)(function(t,e){let{position:i,size:s}=t,{position:n,size:o}=e;return i.x-s.x/2<n.x+o.x/2&&i.x+s.x/2>n.x-o.x/2&&i.y-s.y/2<n.y+o.y/2&&i.y+s.y/2>n.y-o.y/2})(n,t)&&this.handleCollision(n,t)}handleCollision(t,e){let{player:i}=this,s=t.size.x,n=t.size.y,o=t.position.x-s/2,l=t.position.y-n/2,r=e.size.x,a=e.size.y,h=e.position.x-r/2,c=e.position.y-a/2,p=Math.min(o+s,h+r)-Math.max(o,h),u=Math.min(l+n,c+a)-Math.max(l,c);p<u?(o<h?i.position.x-=p:i.position.x+=p,i.velocity.x=0):(l<c?i.position.y-=u:i.position.y+=u,i.velocity.y=0)}onCursorMove(){if(this.disableMouseCamera)return;let{player:t,cursor:e,levelRenderer:i}=this,s=i.cellPositionAt(e.position);t.lookAt(s)}onMouseWheel(t){if(t.ctrlKey)return;t.preventDefault();let e=t.deltaY>0?-1:1;this.player.fovDegrees+=e,this.player.fovDegrees=c(this.player.fovDegrees,1,179),this.player.fov=r(this.player.fovDegrees)}}class k{constructor(t){this.canvas=t,this.ctx=t.getContext("2d")}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}fillRect(t){let{position:i,size:s}=t,n=e.divScalar(s,2);this.ctx.fillRect(i.x-n.x,i.y-n.y,s.x,s.y)}fillText(t,e){this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t,e.x,e.y)}fillCircle(t,e){this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.closePath()}strokeLine(t){this.ctx.beginPath(),this.ctx.moveTo(t.p1.x,t.p1.y),this.ctx.lineTo(t.p2.x,t.p2.y),this.ctx.stroke(),this.ctx.closePath()}drawPolygon(t,e){let{points:i}=t,s=i[0];this.ctx.beginPath(),this.ctx.moveTo(s.x,s.y);for(let t=1;t<i.length;t++){let e=i[t];this.ctx.lineTo(e.x,e.y)}this.ctx.lineTo(s.x,s.y),this.ctx[e](),this.ctx.closePath()}strokePolygon(t){this.drawPolygon(t,"stroke")}fillPolygon(t){this.drawPolygon(t,"fill")}createLinearGradient(t){return this.ctx.createLinearGradient(t.p1.x,t.p1.y,t.p2.x,t.p2.y)}translate(t){this.ctx.translate(t.x,t.y)}scale(t){this.ctx.scale(t.x,t.y)}save(){this.ctx.save()}restore(){this.ctx.restore()}set fillStyle(t){this.ctx.fillStyle=t}set strokeStyle(t){this.ctx.strokeStyle=t}set lineWidth(t){this.ctx.lineWidth=t}set lineCap(t){this.ctx.lineCap=t}set lineJoin(t){this.ctx.lineJoin=t}set font(t){this.ctx.font=t}set globalAlpha(t){this.ctx.globalAlpha=t}}class I{constructor(){this.size=new e(0,0),this.canvas=document.querySelector("canvas"),this.ctx=new k(this.canvas),this.resize(),window.addEventListener("resize",()=>{this.resize()})}resize(t=window.innerWidth,e=window.innerHeight){this.canvas.width=t,this.canvas.height=e,this.size.set(t,e),this.onResize()}onResize(){}}class L extends I{constructor(t,i,s){super(),this.blockSize=0,this.viewCount=2,this.fovRaysLength=1e4,this.renderGrid=!1,this.fovLines=[],this.centerFovLine=new l(new e(0,0),new e(0,0)),this.centerIntersection=new e(0,0),this.fovPolygon=new z([]),this.levelHalfSize=new e(0,0),this.offset=new e(0,0),this.viewSize=new e(0,0),this.level=t,this.player=i,this.visibility=s,this.init(),this.update(),this.onResize()}onResize(){if(!this.visibility)return;this.updateProperties();let t=this.cellPositionAt(new e(0,0)),i=this.size.clone().divScalar(this.blockSize);this.visibility.setBounds(t,i)}init(){this.levelHalfSize=e.divScalar(this.level.size,2),this.offset=e.mulScalar(this.levelHalfSize,-1).addScalar(.5),this.visibility.loadMap(this.level.rects),this.level.forEach(i=>{let{position:s}=i,n=new t(s,new e(1,1)),o=y(n),l=d(n);i.userData={rect:n,points:o,lines:l,pointsInFov:[],insideFov:!1}})}updateProperties(){let{size:t,viewCount:i,level:s}=this;this.viewSize=new e(t.x/i,t.y),this.blockSize=e.div(this.viewSize,s.size).min()}updateFovTriangle(){let{fovRaysLength:t,player:i}=this,s=s=>e.fromAngle(i.angle+s).mulScalar(t).add(i.position),n=i.fov/2,o=s(-n),r=s(n);this.fovLines=[new l(i.position,o),new l(i.position,r)],this.centerFovLine=new l(i.position,e.fromAngle(i.angle).mulScalar(t).add(i.position));let h=null,c=1/0;for(let t of this.level.lines){let e=u(this.centerFovLine,t);if(e?.cross){let t=a(i.position,e.position);t<c&&(c=t,h=e.position)}}this.centerIntersection=h??this.centerFovLine.p2}isPointInFov(t){let e=h(this.player.position,t);return Math.abs(e=p(e-this.player.angle))<=this.player.fov/2}isCellInFov(t){let{rect:i,points:s}=t.userData;return function(t,i){let{position:s,size:n}=i,o=e.divScalar(n,2);return t.x>=s.x-o.x&&t.x<=s.x+o.x&&t.y>=s.y-o.y&&t.y<=s.y+o.y}(this.player.position,i)||s.some(t=>this.isPointInFov(t))}updateCell(t){t.userData.insideFov=this.isCellInFov(t)}update(){this.updateProperties(),this.updateFovTriangle(),this.level.forEach(t=>{this.updateCell(t)}),this.fovPolygon=this.visibility.getClippedPolygon(this.fovLines)}render(){this.ctx.clear(),this.renderView(()=>this.render2DView(),0),this.renderView(()=>this.render3DView(),1)}getViewCenter(t){let i=e.divScalar(this.viewSize,2);return i.x+=t*this.viewSize.x,i}cellPositionAt(t){let i=this.getViewCenter(0);return e.sub(t,i).divScalar(this.blockSize).add(this.levelHalfSize).subScalar(.5)}renderView(t,e){let i=this.getViewCenter(e);this.ctx.save(),this.ctx.translate(i),t(),this.ctx.restore()}render2DView(){let{ctx:t,blockSize:i,offset:s,level:n,player:o}=this;t.scale(new e(i,i)),t.translate(s),this.renderGrid&&n.forEach(e=>{let{char:i,position:s}=e,{insideFov:n}=e.userData;t.globalAlpha=n?1:.25,t.fillStyle=v.characters[i]||"white",t.font="1px Arial",t.fillText(i,s),t.globalAlpha=1}),t.fillStyle=v.player,t.fillCircle(o.position,.25),t.lineWidth=.075,t.lineCap="round",t.lineJoin="round",t.strokeStyle="white",t.strokePolygon(this.visibility.outputPolygon),t.strokeStyle="yellow",t.strokePolygon(this.fovPolygon)}render3DView(){let{ctx:i}=this;i.fillStyle="#101010",i.fillRect(new t(new e(0,0),this.viewSize));let s=[],n=this.fovPolygon.points.slice(1),o=this.size.y,r=this.player.fov/2,c=t=>(p(t-this.player.angle)+r)/this.player.fov,u=c(this.player.angle-r),y=c(this.player.angle+r);for(let t=0;t<n.length;t++){let e=n[t],i=h(this.player.position,e),l=c(i),r=Math.cos(i-this.player.angle),p=o/(a(this.player.position,e)*r),d=(l-u)/(y-u),x=this.viewSize.x*d-this.viewSize.x/2,f=p/o;s.push({x:x,height:p,brightness:f})}for(let t=0;t<s.length;t++){let n=s[t],o=s[t+1];if(!o)break;let r=n.x,a=o.x,h=n.height,c=o.height,p=n.brightness,u=o.brightness,y=new z([new e(r,-h/2),new e(r,h/2),new e(a,c/2),new e(a,-c/2)]),d=i.createLinearGradient(new l(new e(r,0),new e(a,0))),x="200, 200, 200";d.addColorStop(0,`rgba(${x}, ${p})`),d.addColorStop(1,`rgba(${x}, ${u})`),i.fillStyle=d,i.fillPolygon(y),i.strokeStyle="black",i.lineWidth=window.innerWidth/1e3,i.strokePolygon(y)}}}!function(){let t=document.querySelector(".close-info-btn");t.addEventListener("click",()=>{t.closest(".info-overlay").classList.add("close")});let e=g.fromString(w),i=new P(e.find("@").position.clone()),s=new D(i),n=new L(e,i,s),o=new m,l=new S,r=new C(i,l,o,n),a=performance.now(),h=0;!function t(){let e=performance.now(),i=e-a;for(a=e,h+=i;h>=16.666666666666668;)r.update(),s.update(),n.update(),n.render(),h-=16.666666666666668;requestAnimationFrame(t)}(),Object.assign(window,{player:i,level:e,visibility:s,levelRenderer:n,cursor:o,keyboard:l})}();
//# sourceMappingURL=2d-raycaster.b97e1aa9.js.map
